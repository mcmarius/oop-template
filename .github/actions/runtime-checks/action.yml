name: 'Runtime checks'
description: 'Run dynamic analysis tools'

runs:
  using: "composite"
  steps:
    - name: Sanitizers
      shell: bash
      # run one sanitizer for each env to avoid building extra binaries on one env
      if: matrix.runs_asan == true && runner.os != 'Windows'
      # detect_leaks is not supported on macOS
      # env:
      #   ASAN_OPTIONS: detect_leaks=1
      run: |
        # run LLM server in background
        source ./scripts/run_llm.sh
        cat "${INPUT_FILENAME}" | tr -d '\r' | ./${{ env.ZIP_NAME }}/"${EXECUTABLE_NAME}"
        # server shutdown
        kill -TERM $(jobs -p)

    - name: Sanitizers (Windows MSVC)
      shell: bash
      # run one sanitizer for each OS to avoid building extra binaries
      if: matrix.cxx == 'cl' && matrix.runs_asan == true
      continue-on-error: true
      run: |
        # run LLM server in background
        source ./scripts/run_llm.sh
        cat "${INPUT_FILENAME}" | ./${{ env.ZIP_NAME }}/"${EXECUTABLE_NAME}".exe
        # server shutdown
        kill -TERM $(jobs -p)

    - name: Valgrind
      shell: bash
      if: runner.os == 'Linux' && matrix.runs_valgrind == true
      run: |
        # run LLM server in background
        source ./scripts/run_llm.sh
        bash ./scripts/run_valgrind.sh "${{ env.ZIP_NAME }}"
        # server shutdown
        kill -TERM $(jobs -p)
