name: 'Runtime checks'
description: 'Run dynamic analysis tools'

runs:
  using: "composite"
  steps:
    - name: Make scripts executable
      shell: bash
      if: runner.os == 'Linux'
      run: |
        chmod +x scripts/*

    - name: Sanitizers
      shell: bash
      # run one sanitizer for each env to avoid building extra binaries on one env
      if: matrix.runs_asan == true && runner.os == 'Linux'
      # detect_leaks is not supported on macOS
      # ASAN_OPTIONS: detect_leaks=1
      continue-on-error: true
      env:
        ASAN_OPTIONS: halt_on_error=0
        EXECUTABLE_NAME: ${{ env.EXECUTABLE_NAME }}
      run: |
          xvfb-run ./scripts/run_sanitizers.sh || true
      working-directory: ${{github.workspace}}

    - name: Valgrind
      shell: bash
      if: runner.os == 'Linux' && matrix.runs_valgrind == true
      continue-on-error: true
      env:
        EXECUTABLE_NAME: ${{ env.EXECUTABLE_NAME }}
      run: |
        xvfb-run ./scripts/run_valgrind.sh "${{ env.ZIP_NAME }}" || true
      working-directory: ${{github.workspace}}
